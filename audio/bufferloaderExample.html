<!DOCTYPE html>
<html>
<head>
	<title>Buffer loader example</title>
</head>
<body>
<h2>This example uses the BufferLoader object</h2>
</body>
</html>


<script type="text/javascript">

main()	

function main() {
	let audioContext = new window.AudioContext()
	if (!audioContext) { return }

	let soundUrls = [
		"/media/bit1.wav",
		"/media/bit2.wav",
		"/media/bit3.wav"
	]

	let loader = new BufferLoader(audioContext, soundUrls, finishedLoading)
	loader.load()
}

function finishedLoading(audioContext, bufferList) {
	for (var i = 0; i < bufferList.length; i++) {
		let source = audioContext.createBufferSource()
		
		source.buffer = bufferList[i] 
		source.connect( audioContext.destination )
		source.start( audioContext.currentTime + i )
	}	
}

function BufferLoader(audioContext, audioUrls, finishedLoading) {
	if(!(this instanceof BufferLoader)) {
		return new BufferLoader(audioContext, audioUrls, finishedLoading)
	}
	let audioUrlCount = audioUrls.length
	let bufferList = []

	this.audioContext = audioContext
	this.audioUrls = audioUrls
	this.finishedLoading = finishedLoading

	this.load = () => {
		if(audioUrls.length == 0){
			finishedLoading([])	
			return
		}	

		for (var i = 0; i < audioUrls.length; i++) {
			let fileUrl = audioUrls[i]
			let request = new XMLHttpRequest()

			request.open('GET', fileUrl, true)
			request.responseType = 'arraybuffer'
			request.onload = onRequestLoaded(audioContext, request)
			request.send()		
		}			
	}


	function onRequestLoaded(audioContext, request) {
		return () => {
			if(!audioContext) { return }
			if(!request) { return }
			console.log(request)
			audioContext.decodeAudioData(request.response, onDecodedAudioBuffer(audioContext), onDecodedAudioBufferError)
			console.log("Request loaded")		
		}	
	}

	function onDecodedAudioBuffer(audioContext){
		return (buffer) => {
			if(!audioContext) { return }
			if(!buffer){ return }
		
			audioUrlCount -= 1
			bufferList.push( buffer )

			if( audioUrlCount == 0 ){
				finishedLoading( audioContext, bufferList )
				return
			}



			// let source = audioContext.createBufferSource()
			// source.buffer = buffer
			// source.connect(audioContext.destination)
			// source.start(0)			
		}
	}


	function onDecodedAudioBufferError() {
		console.log("Error decoding audio buffer")
	}
}





</script>